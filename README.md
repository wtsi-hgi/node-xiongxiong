# Xiongxiong

Bearer token generator and validator.

## Installation

Install from NPM:

    npm install xiongxiong

## Xiongxiong?

"熊" (xiong, /ɕjʊ̌ŋ/) is Mandarin Chinese for "bear" (as in the mammal).
Reduplication in Mandarin acts as a diminutiviser, so "熊熊" means
something like "little bear".

Bear, bearer, bearer token... Yeah, it's tenuous, but deal with it!

# Documentation

The module *must* be instantiated with a private key and, optionally, a
token lifetime (in seconds; defaults to 3600) and hashing algorithm
(defaults to `sha1`). These can be provided as positional arguments, or
as a hash.

For example:

```js
var fs         = require('fs'),
    privateKey = fs.readFileSync('/path/to/private.key');

var xiongxiong = require('xiongxiong')(privateKey, 3600, 'md5');
```

...or:

```js
var xiongxiong = require('xiongxiong')({
  privateKey: 'My hovercraft is full of eels!',
  lifetime:   300,
  algorithm:  'whirlpool'
});
```

The private key can be any buffer or string; it needn't be read from the
filesystem (but that's probably a good idea). A simple key generation
script is also provided (see below).

An error will be thrown if the hashing algorithm is unsupported on your
system.

## `xiongxiong.create(data, callback)`

Asynchronously create the bearer token generated by `data` and pass it
to the `callback`. The callback follows the "error first" pattern, with
any error in the first argument (`null`, otherwise) and the token data
in the second.

The data provided to the function must be a string or an array of
strings. In the latter case, the array is flattened with interposing `:`
characters.

The token data available to the callback is a hash, with keys:
* `expiration` The token's expiration time (Unix epoch)
* `accessToken` The token itself
* `basicLogin` Basic authentication login
* `basicPassword` Basic authentication password

`basicLogin` is the Base64 encoding of the input `data`, with a
cryptographic salt, as a fallback for when HTTP Bearer authentication is
not available. `basicPassword` is the HMAC of `basicLogin` with the
private key using the specified hashing algorithm. The `accessToken` is
simply these two pieces concatenated, again with an interposed `:`.

For example:

```js
xiongxiong.create([userName, sessionID], function(err, token) {
  if (err) {
    throw err;
  }

  console.log(JSON.stringify(token, null, '  '));
});
```

n.b., Don't put `:`s in your seed data; they act as delimiters and
spurious ones will probably mess up with the validation.

## `xiongxiong.extract(accessToken)`
## `xiongxiong.extract(basicLogin, basicPassword)`

Extract the seed data, expiration and validate from the bearer
token/basic authentication pair. Returns a hash with the following keys:

* `data` The original seed data, which will be an array split by `:`
  characters, wherever possible (a string, otherwise).
* `expiration` The expiration time (`Date` object).
* `isValid` The validity of the token/basic pair (`Boolean`).

For example:

```js
var tokenData = xiongxiong.extract(someToken);

if (tokenData.isValid) {
  console.log('Token expires in',
              Math.floor((tokenData.expiration - Date.now()) / 1000)
              'seconds.');
}
```

# `make-key.sh`

A simple wrapper script around `dd` to create a private key file from
`/dev/random`.

## Usage

    make-key.sh [options]

    Options:
      -s SIZE     Key size, in bytes (default 256)
      -o KEYFILE  Key file (default private.key)
      -h          This useful message

# License

Copyright (c) 2014, 2015 Genome Research Limited

This program is free software: you can redistribute it and/or modify it
under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or (at
your option) any later version.

This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the [GNU Affero
General Public License](LICENSE) for more details.

You should have received a copy of the GNU Affero General Public License
along with this program. If not, see <http://www.gnu.org/licenses/>.
